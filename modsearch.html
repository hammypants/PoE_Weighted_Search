<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mod Search Generator</title>
    <script src="brython/brython.js" type="text/javascript"></script>
    <script src="brython/brython_stdlib.js" type="text/javascript"></script>
    <link href="css/layout.css" rel="stylesheet" type="text/css" />

</head>
<body onload="brython(1)">
<script type="text/python" src="gensearchparams.py"></script>
<section class="main">
    <strong>Using this page.</strong> <br>
    You need to add jewels to Path of Building, if you have not yet done so.<br><br>
    <a href="https://raw.githubusercontent.com/xanthics/PoE_Weighted_Search/master/jewellist.txt">Text file to add jewels by hand</a><br><br>
    <a href="https://raw.githubusercontent.com/xanthics/PoE_Weighted_Search/master/jewellistxml.txt">xml file to add jewels direction to Path of Building Settings at your own risk.</a>  As pointed out by github user coldino, you can edit your My Documents/Path of Building/Settings.xml directly. The lines from jewellistxml.txt should be added directly after the &lt;SharedItems&gt; tag. &lt;Shared Items&gt; should be right after &lt;/Accounts&gt;<br><br>
    You then need to spec an empty jewel node on your tree in PoB and mouse over each added jewel for the values to add in this table.  After filling in the table and selection the relevant mods, click "Generate Query" and a query string will be created for you.<br><br>
    This page requires javascript in order to run.  If you can see a table to enter your damage values then it is working.<br>
    <br>

    <table id="mod weights">
    </table> <br><br>

    <strong>Minion Nodes?:</strong> Select if you have the nodes selected on your tree or are wearing the Scourge.<br>
    <table>
    <tr><td><label><input type="checkbox" name="Minion Damage">Minion Damage</label></td><td><label><input type="checkbox" name="Minion Attack Speed">Minion Attack Speed</label></td></tr>
    </table><br><br>

    <strong>Type:</strong> Generally select 1 based on your type of attack<br>
    <table>
    <tr><td><label><input type="checkbox" name="Attack">Attack</label></td><td><label><input type="checkbox" name="Spell">Spell</label></td>
    </table><br><br>

    <strong>Class:</strong> If you are attack based, select 1 or more(Varunastra) weapon types.  Trap/Mine/Totem if you are using those supports<br>
    <table>
    <tr><td><label><input type="checkbox" name="Mace">Mace</label></td><td><label><input type="checkbox" name="Bow">Bow</label></td><td><label><input type="checkbox" name="Wand">Wand</label></td><td><label><input type="checkbox" name="Claw">Claw</label></td></tr>
    <tr><td><label><input type="checkbox" name="Staff">Staff</label></td><td><label><input type="checkbox" name="Sword">Sword</label></td><td><label><input type="checkbox" name="Axe">Axe</label></td><td><label><input type="checkbox" name="Dagger">Dagger</label></td></tr>
    <tr><td><label><input type="checkbox" name="Trap">Trap</label></td><td><label><input type="checkbox" name="Mine">Mine</label></td><td><label><input type="checkbox" name="Totem">Totem</label></td></tr>
    </table><br><br>

    <strong>Tags:</strong> Check all the tags that match your primary skill<br>
    <table>
    <tr><td><label><input type="checkbox" name="Melee">Melee</label></td><td><label><input type="checkbox" name="Area">Area</label></td><td><label><input type="checkbox" name="Projectile">Projectile</label></td><td><label><input type="checkbox" name="Elemental">Elemental</label></td></tr>
    <tr><td><label><input type="checkbox" name="Fire">Fire</label></td><td><label><input type="checkbox" name="Cold">Cold</label></td><td><label><input type="checkbox" name="Lightning">Lightning</label></td></tr>
    </table><br><br>

    <strong>Hands:</strong> choose 1 based on wielded weapons<br>
    <table>
    <tr><td><label><input type="checkbox" name="Shield">Shield</label></td><td><label><input type="checkbox" name="Dual Wielding">Dual Wielding</label></td><td><label><input type="checkbox" name="Two Handed Weapon">Two Handed Weapon</label></td></tr>
    </table><br><br>

    <strong>Charges:</strong> Do you sustain charges?<br>
    <table>
    <tr><td><label><input type="checkbox" name="Frenzy">Frenzy</label></td><td><label><input type="checkbox" name="Power">Power</label></td><td><label><input type="checkbox" name="Endurance">Endurance</label></td></tr>
    </table><br><br>

    <strong>Recently:</strong> Tic all the things your build can do 'recently'<br>
    <table>
    <tr><td><label><input type="checkbox" name="Recent Crit">Crit</label></td><td><label><input type="checkbox" name="Recent Kill">Kill</label></td><td><label><input type="checkbox" name="Recent Hit">Hit</label></td></tr>
    <tr><td><label><input type="checkbox" name="No Recent Crit">Not Crit</label></td><td><label><input type="checkbox" name="No Recent Kill">Not Kill</label></td></tr>
    </table><br><br>

    <strong>You are/have:</strong> Tic all the things affecting you<br>
    <table>
    <tr><td><label><input type="checkbox" name="Flasked">Flasked</label></td><td><label><input type="checkbox" name="Elder">Other Ring is Elder</label></td><td><label><input type="checkbox" name="Shaper">Other Ring is Shaper</label></td></tr>
    </table><br><br>

    <strong>Enemy is:</strong> status effects on your target<br>
    <table>
    <tr><td><label><input type="checkbox" name="Chilled">Chilled</label></td><td><label><input type="checkbox" name="Blinded">Blinded</label></td></tr>
    </table><br><br>

    <div id="generate"></div><br>
    <a href="" id="query" target="_blank">Search</a><br><br>
    <div id="notice">This url may take more than 1 try to load.  I do not know why the official site fails some times.  Note that the sum of the weights is an approximation as stats scale in relation to each other.  EG crit multi becomes more valuable the higher your crit chance is, while crit chance becomes less valuable.  Looking at each mod in isolation cannot perfectly recreate that.</div><br>

    <script type="text/python">
        from browser import document as doc
        from browser import html
        from browser.html import TABLE, TR, TH, TD
        from gensearchparams import gensearchparams
        import json

        def generate_query(ev):
            dps = {}
            for elt in doc.get(selector='input[type="number"]'):
                dps[elt.name] = float(elt.value)/float(elt.getAttribute("data-normal"))
            dps['extra random'] = (dps['extra fire'] + dps['extra cold'] + dps['extra lightning']) / 3
            selections = set()
            for elt in doc.get(selector='input[type="checkbox"]'):
                if elt.checked:
                    selections.add(elt.name)
            querystring = gensearchparams(dps, selections)
            doc["query"].href = querystring
            doc["query"].style.display = "inline"
            doc["notice"].style.display = "inline"

        def create_table():
            f = open('mods.json', 'r')
            mjson = json.loads(f.read())
            f.close()
            t = TABLE()
            th = TR()
            th <= TH("Damage")
            th <= TH("Jewel Mod")
            t <= th
            for m in mjson:
                t <= TR( TD( '<input type="number" name="{}" value="0" data-normal="{}">'.format(m['name'], m['count']) ) + TD( m['desc'] ) )
            doc['mod weights'] <= t

        def process_querystring():
            for elt in doc.get(selector='input[type="number"]'):
                try:
                    elt.value = doc.query[elt.name]
                except KeyError:
                    elt.value = 0
            for elt in doc.get(selector='input[type="checkbox"]'):
                try:
                    if doc.query[elt.name] == "True":
                        elt.checked = True
                except KeyError:
                    elt.checked = False

        doc["query"].style.display = "none"
        doc["notice"].style.display = "none"
        b_generate = html.BUTTON("Generate Query")
        b_generate.bind("click", generate_query)
        doc["generate"] <= b_generate
        create_table()
        process_querystring()
    </script>


</section>
</body>
</html>