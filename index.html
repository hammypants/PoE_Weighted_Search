<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mod Search Generator</title>
    <script src="https://cdn.rawgit.com/brython-dev/brython/3.6.2/www/src/brython.js" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/brython-dev/brython/3.6.2/www/src/brython_stdlib.js" type="text/javascript"></script>
    <link href="css/layout.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
</head>
<body onload="brython(1)">
<script type="text/python" src="gensearchparams.py"></script>
<section class="main">
    <div id="instruction"></div>
    <div id="instructions">
        <h1>Using this page.</h1>
        There are 2 primary ways to use this page.  A script created by coldino, or manually adding the jewels with the necessary mods to PoB and copying the values over by hand.
        <h3>Using coldino script</h3>
        Go to <a href ='https://github.com/Openarl/PathOfBuilding/releases' target="_blank">PoB releases page</a> and download the PathOfBuilding-x.x.xxx.zip file.<br>
        extract files to a directory <br>
        Copy your existing builds to the Build directory <br>
        Navigate to <a href="https://github.com/VolatilePulse/PoB-Item-Tester" target="_blank">Coldino's Github Repository</a> <br>
        Clone or download, unzip, and enter directory <br>
        Run TestItem.ahk, select the build you want from the list.<br>
        Ctrl+Windows+d and it should automatically open this page with values filled out. <br>
        Ctrl+Alt+Windows+d will prompt you to choose build and then automatically open this page. <br><br>
        Double check all of the flags at the end to make sure they match what you are trying to do.  EG if you are molten strike you probably don't care about the melee flag as the projectile part is much more important <br><br><br>
        <strong>Troubleshooting:</strong> <br>
        After the first time you run TestItem.ahk it will generate TestItem.ini.  You may need to modify "PathToPoB" <br>
        <h3>Manually copy from PoB</h3>
        You need to add jewels to Path of Building, if you have not yet done so.<br><br>
        <a href="jewellist.txt" target="_blank">Text file to add jewels by hand</a><br><br>
        <a href="jewellistxml.txt" target="_blank">xml file to add jewels direction to Path of Building Settings (at your own risk).</a>  As pointed out by github user coldino, you can edit your My Documents/Path of Building/Settings.xml directly. The lines from jewellistxml.txt should be added directly after the &lt;SharedItems&gt; tag. &lt;Shared Items&gt; should be right after &lt;/Accounts&gt;<br><br>
        You then need to spec an empty jewel node on your tree in PoB and mouse over each added jewel for the values to add in this table.  After filling in the table and selection the relevant mods, click "Generate Query" and a query string will be created for you.<br><br>
    </div>
    <br>
    This page requires javascript in order to run.  If you can see a table to enter your damage values then it is working.<br>
    <br>

    <div id="Character"><strong>Build Name:</strong> </div>
    <div id="Skill"><strong>Skill:</strong> </div></div>

    <table id="mod weights">
    </table> <br><br>

    <strong>Charges:</strong> Do you sustain charges?<br>
    <table>
    <tr><td><label><input type="checkbox" id="useFrenzyCharges">Frenzy</label></td><td><label><input type="checkbox" id="usePowerCharges">Power</label></td><td><label><input type="checkbox" id="useEnduranceCharges">Endurance</label></td></tr>
    </table><br><br>

    <strong>Charge count:</strong> The max number of each type of charge your build sustains<br>
    <table>
    <tr><td><input type="number" name="PowerCount" value="0" data-normal="1" style="width: 3em"></td><td>Power</td></tr>
    <tr><td><input type="number" name="FrenzyCount" value="0" data-normal="1" style="width: 3em"></td><td>Frenzy</td></tr>
    <tr><td><input type="number" name="EnduranceCount" value="0" data-normal="1" style="width: 3em"></td><td>Endurance</td></tr>
    </table><br><br>

    <strong>Type:</strong> Generally select 1 based on your type of attack<br>
    <table>
    <tr><td><label><input type="checkbox" id="Attack">Attack</label></td><td><label><input type="checkbox" id="Spell">Spell</label></td>
    </table><br><br>

    <strong>Class:</strong> If you are attack based, select 1 or more(Varunastra) weapon types.  Trap/Mine/Totem if you are using those supports<br>
    <table>
    <tr><td><label><input type="checkbox" id="Mace">Mace</label></td><td><label><input type="checkbox" id="Bow">Bow</label></td><td><label><input type="checkbox" id="Wand">Wand</label></td><td><label><input type="checkbox" id="Claw">Claw</label></td></tr>
    <tr><td><label><input type="checkbox" id="Staff">Staff</label></td><td><label><input type="checkbox" id="Sword">Sword</label></td><td><label><input type="checkbox" id="Axe">Axe</label></td><td><label><input type="checkbox" id="Dagger">Dagger</label></td></tr>
    <tr><td><label><input type="checkbox" id="Trap">Trap</label></td><td><label><input type="checkbox" id="Mine">Mine</label></td><td><label><input type="checkbox" id="Totem">Totem</label></td></tr>
    </table><br><br>

    <strong>Tags:</strong> Check all the tags that match your primary skill<br>
    <table>
    <tr><td><label><input type="checkbox" id="Melee">Melee</label></td><td><label><input type="checkbox" id="Area">Area</label></td><td><label><input type="checkbox" id="Projectile">Projectile</label></td><td><label><input type="checkbox" id="Elemental">Elemental</label></td></tr>
    <tr><td><label><input type="checkbox" id="Fire">Fire</label></td><td><label><input type="checkbox" id="Cold">Cold</label></td><td><label><input type="checkbox" id="Lightning">Lightning</label></td></tr>
    </table><br><br>

    <strong>Hands:</strong> choose 1 based on wielded weapons<br>
    <table>
    <tr><td><label><input type="checkbox" id="Shield">Shield</label></td><td><label><input type="checkbox" id="DualWielding">Dual Wielding</label></td><td><label><input type="checkbox" id="TwoHandedWeapon">Two Handed Weapon</label></td></tr>
    </table><br><br>

    <strong>Recently:</strong> Tic all the things your build can do 'recently'<br>
    <table>
    <tr><td><label><input type="checkbox" id="conditionKilledRecently">You Kill</label></td><td><label><input type="checkbox" id="conditionCritRecently">Crit</label></td><td><label><input type="checkbox" id="conditionHitRecently">Hit</label></td></tr>
    <tr><td><label><input type="checkbox" id="conditionMinionsKilledRecently">Minion Kill</label></td><td><label><input type="checkbox" id="No Recent Crit">Not Crit</label></td><td><label><input type="checkbox" id="conditionUsedMinionSkillRecently">Minion Skill</label></td></tr>
    <tr><td><label><input type="checkbox" id="No Recent Kill">Not Kill</label></td></tr>
    </table><br><br>

    <strong>You are/have:</strong> Tic all the things affecting you<br>
    <table>
    <tr><td><label><input type="checkbox" id="conditionUsingFlask">Flasked</label></td><td><label><input type="checkbox" id="Elder">Other Ring is Elder</label></td><td><label><input type="checkbox" id="Shaper">Other Ring is Shaper</label></td></tr>
    <tr><td><label><input type="checkbox" id="conditionFullLife">Full Life</label></td></tr>
    </table><br><br>

    <strong>Enemy is:</strong> status effects on your target<br>
    <table>
	<tr><td><label><input type="checkbox" id="conditionEnemyBleeding">Bleeding</label></td><td><label><input type="checkbox" id="conditionEnemyPoisoned">Poisoned</label></td><td><label><input type="checkbox" id="conditionEnemyBlinded">Blinded</label></td></tr>
	<tr><td><label><input type="checkbox" id="conditionEnemyIgnited">Ignited</label></td><td><label><input type="checkbox" id="conditionEnemyBurning">Burning</label></td><td><label><input type="checkbox" id="conditionEnemyShocked">Shocked</label></td></tr>
    <tr><td><label><input type="checkbox" id="conditionEnemyChilled">Chilled</label></td><td><label><input type="checkbox" id="conditionEnemyFrozen">Frozen</label></td></tr>
    </table><br><br>

    <div id="generate"></div><br>
    <a href="" id="query" target="_blank">Search</a><br><br>
    <div id="414by"> If you get a '414 Request-URI Too Large' download <a href="bypass414.py" download>this python script</a>, run it, and paste this string <br><input type="text" id="414bypass" onClick="this.select();" readonly>. <br><br></div>
    <div id="notice">This url may take more than 1 try to load.  I do not know why the official site fails some times.  Note that the sum of the weights is an approximation as stats scale in relation to each other.  EG crit multi becomes more valuable the higher your crit chance is, while crit chance becomes less valuable.  Looking at each mod in isolation cannot perfectly recreate that.</div><br>

    <script type="text/python">
        from browser import document as doc
        from browser import html
        from browser.html import TABLE, TR, TH, TD
        from gensearchparams import gensearchparams
        import json

        url = 'https://www.pathofexile.com/trade/search/Delve'
        url_api = 'https://www.pathofexile.com/api/trade/search/Betrayal?redirect&source='

        def generate_query(ev):
            dps = {}
            for elt in doc.get(selector='input[type="number"]'):
                dps[elt.name] = float(elt.value)/float(elt.getAttribute("data-normal"))
            dps['extra random'] = (dps['extra fire'] + dps['extra cold'] + dps['extra lightning']) / 3
            selections = set()
            for elt in doc.get(selector='input[type="checkbox"]'):
                if elt.checked:
                    selections.add(elt.id)
            querystring = gensearchparams(dps, selections)
            doc["query"].href = url_api + querystring
            doc["414bypass"].value = querystring
            doc["query"].style.display = "inline"
            doc["notice"].style.display = "inline"
            doc["414by"].style.display = "inline"

        def toggle_instructions(ev):
            if doc["instructions"].style.display == "none":
                doc["instructions"].style.display = "inline"
            else:
                doc["instructions"].style.display = "none"

        def create_table():
            f = open('mods.json', 'r')
            mjson = json.loads(f.read())
            f.close()
            t = TABLE()
            th = TR()
            th <= TH("Damage")
            th <= TH("Jewel Mod")
            t <= th
            for m in mjson:
                t <= TR( TD( '<input type="number" name="{}" value="0" data-normal="{}">'.format(m['name'], m['count']) ) + TD( m['desc'] ) )
            doc['mod weights'] <= t

        def process_querystring():
            for elt in doc.get(selector='input[type="number"]'):
                try:
                    elt.value = doc.query[elt.name]
                except KeyError:
                    elt.value = 0
#            for elt in doc.get(selector='input[type="checkbox"]'):
#                try:
#                    if doc.query[elt.name] == "True":
#                        elt.checked = True
#                except KeyError:
#                    elt.checked = False
            try:
                flags = doc.query["Flags"].strip(',').split(',')
                for f in flags:
                    try:
                        doc[f].checked = True
                    except KeyError:
                        print("Flag '{}' recieved but not currently supported.".format(f))
                if 'conditionCritRecently' not in flags:
                    doc["No Recent Crit"].checked = True
                if 'conditionKilledRecently' not in flags:
                    doc["No Recent Kill"].checked = True
            except KeyError:
                print("No Flags parameter passed in query string")

            for val in ['Skill', 'Character']:
                try:
                    if doc.query[val]:
                        doc[val] <= doc.query[val]
                except KeyError:
                    doc[val].style.display = "none"

        doc["query"].style.display = "none"
        doc["notice"].style.display = "none"
        doc["414by"].style.display = "none"
        doc["instructions"].style.display = "none"
        b_generate = html.BUTTON("Generate Query")
        b_generate.bind("click", generate_query)
        doc["generate"] <= b_generate
        b_generate = html.BUTTON("<strong>Toggle Instructions</strong>")
        b_generate.bind("click", toggle_instructions)
        doc["instruction"] <= b_generate
        create_table()
        process_querystring()
    </script>


</section>
</body>
</html>